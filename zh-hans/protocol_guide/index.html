<!doctype html><html lang="en" class="no-js"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="description" content="The wiki page served for bpm"><link rel="canonical" href="https://yyc12345.github.io/bpm_wiki/zh-hans/protocol_guide/"><meta name="author" content="yyc12345"><meta name="lang:clipboard.copy" content="Copy to clipboard"><meta name="lang:clipboard.copied" content="Copied to clipboard"><meta name="lang:search.language" content="en"><meta name="lang:search.pipeline.stopwords" content="True"><meta name="lang:search.pipeline.trimmer" content="True"><meta name="lang:search.result.none" content="No matching documents"><meta name="lang:search.result.one" content="1 matching document"><meta name="lang:search.result.other" content="# matching documents"><meta name="lang:search.tokenizer" content="[\s\-]+"><link rel="shortcut icon" href="../../img/favicon.ico"><meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.3.1"><title>bpm网络协议手册 - bpm Wiki</title><link rel="stylesheet" href="../../assets/stylesheets/application.4031d38b.css"><link rel="stylesheet" href="../../assets/stylesheets/application-palette.224b79ff.css"><meta name="theme-color" content="#009688"><script src="../../assets/javascripts/modernizr.74668098.js"></script><link rel="stylesheet" href="../../assets/fonts/material-icons.css"></head><body dir="ltr" data-md-color-primary="teal" data-md-color-accent="teal"><svg class="md-svg"><defs><svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="__github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg></defs></svg> <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off"> <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off"> <label class="md-overlay" data-md-component="overlay" for="__drawer"></label><a href="#bpm" tabindex="1" class="md-skip">Skip to content </a><header class="md-header" data-md-component="header"><nav class="md-header-nav md-grid"><div class="md-flex"><div class="md-flex__cell md-flex__cell--shrink"><a href="https://yyc12345.github.io/bpm_wiki/" title="bpm Wiki" class="md-header-nav__button md-logo"><i class="md-icon">book</i></a></div><div class="md-flex__cell md-flex__cell--shrink"><label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label></div><div class="md-flex__cell md-flex__cell--stretch"><div class="md-flex__ellipsis md-header-nav__title" data-md-component="title"><span class="md-header-nav__topic">bpm Wiki</span><span class="md-header-nav__topic">bpm网络协议手册</span></div></div><div class="md-flex__cell md-flex__cell--shrink"></div><div class="md-flex__cell md-flex__cell--shrink"><div class="md-header-nav__source"><a href="https://github.com/yyc12345/bpm" title="Go to repository" class="md-source" data-md-source="github"><div class="md-source__icon"><svg viewBox="0 0 24 24" width="24" height="24"><use xlink:href="#__github" width="24" height="24"></use></svg></div><div class="md-source__repository">yyc12345/bpm</div></a></div></div></div></nav></header><div class="md-container"><nav class="md-tabs md-tabs--active" data-md-component="tabs"><div class="md-tabs__inner md-grid"><ul class="md-tabs__list"><li class="md-tabs__item"><a href="../.." title="bpm Wiki" class="md-tabs__link">bpm Wiki</a></li><li class="md-tabs__item"><a href="../MAIN/" title="简体中文" class="md-tabs__link md-tabs__link--active">简体中文</a></li><li class="md-tabs__item"><a href="../../en/MAIN/" title="English" class="md-tabs__link">English</a></li></ul></div></nav><main class="md-main"><div class="md-main__inner md-grid" data-md-component="container"><div class="md-sidebar md-sidebar--primary" data-md-component="navigation"><div class="md-sidebar__scrollwrap"><div class="md-sidebar__inner"><nav class="md-nav md-nav--primary" data-md-level="0"><label class="md-nav__title md-nav__title--site" for="__drawer"><a href="https://yyc12345.github.io/bpm_wiki/" title="bpm Wiki" class="md-nav__button md-logo"><i class="md-icon">book</i></a>bpm Wiki</label><div class="md-nav__source"><a href="https://github.com/yyc12345/bpm" title="Go to repository" class="md-source" data-md-source="github"><div class="md-source__icon"><svg viewBox="0 0 24 24" width="24" height="24"><use xlink:href="#__github" width="24" height="24"></use></svg></div><div class="md-source__repository">yyc12345/bpm</div></a></div><ul class="md-nav__list" data-md-scrollfix><li class="md-nav__item"><a href="../.." title="bpm Wiki" class="md-nav__link">bpm Wiki</a></li><li class="md-nav__item md-nav__item--active md-nav__item--nested"><input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2" checked><label class="md-nav__link" for="nav-2">简体中文</label><nav class="md-nav" data-md-component="collapsible" data-md-level="1"><label class="md-nav__title" for="nav-2">简体中文</label><ul class="md-nav__list" data-md-scrollfix><li class="md-nav__item"><a href="../MAIN/" title="主页" class="md-nav__link">主页</a></li><li class="md-nav__item"><a href="../user_guide/" title="用户手册" class="md-nav__link">用户手册</a></li><li class="md-nav__item"><a href="../server_guide/" title="服务器手册" class="md-nav__link">服务器手册</a></li><li class="md-nav__item"><a href="../pack_guide/" title="包构建手册" class="md-nav__link">包构建手册</a></li><li class="md-nav__item"><a href="../database/" title="数据库指南" class="md-nav__link">数据库指南</a></li><li class="md-nav__item md-nav__item--active"><input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc"><label class="md-nav__link md-nav__link--active" for="__toc">bpm网络协议手册</label><a href="./" title="bpm网络协议手册" class="md-nav__link md-nav__link--active">bpm网络协议手册</a><nav class="md-nav md-nav--secondary"><label class="md-nav__title" for="__toc">Table of contents</label><ul class="md-nav__list" data-md-scrollfix><li class="md-nav__item"><a href="#_1" title="基本过程" class="md-nav__link">基本过程</a></li><li class="md-nav__item"><a href="#_2" title="下载请求" class="md-nav__link">下载请求</a><nav class="md-nav"><ul class="md-nav__list"><li class="md-nav__item"><a href="#_3" title="格式" class="md-nav__link">格式</a></li><li class="md-nav__item"><a href="#_4" title="注释" class="md-nav__link">注释</a></li></ul></nav></li><li class="md-nav__item"><a href="#_5" title="回应资源状态" class="md-nav__link">回应资源状态</a><nav class="md-nav"><ul class="md-nav__list"><li class="md-nav__item"><a href="#_6" title="格式" class="md-nav__link">格式</a></li><li class="md-nav__item"><a href="#_7" title="注释" class="md-nav__link">注释</a></li></ul></nav></li><li class="md-nav__item"><a href="#_8" title="下载分片" class="md-nav__link">下载分片</a><nav class="md-nav"><ul class="md-nav__list"><li class="md-nav__item"><a href="#_9" title="客户端分片请求格式" class="md-nav__link">客户端分片请求格式</a></li><li class="md-nav__item"><a href="#_10" title="服务器发送分片格式" class="md-nav__link">服务器发送分片格式</a></li><li class="md-nav__item"><a href="#_11" title="注释" class="md-nav__link">注释</a></li></ul></nav></li><li class="md-nav__item"><a href="#_12" title="下载结束释放资源" class="md-nav__link">下载结束释放资源</a></li></ul></nav></li></ul></nav></li><li class="md-nav__item md-nav__item--nested"><input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3"><label class="md-nav__link" for="nav-3">English</label><nav class="md-nav" data-md-component="collapsible" data-md-level="1"><label class="md-nav__title" for="nav-3">English</label><ul class="md-nav__list" data-md-scrollfix><li class="md-nav__item"><a href="../../en/MAIN/" title="Home Page" class="md-nav__link">Home Page</a></li><li class="md-nav__item"><a href="../../en/user_guide/" title="User Guide" class="md-nav__link">User Guide</a></li><li class="md-nav__item"><a href="../../en/server_guide/" title="Server Operation Manual" class="md-nav__link">Server Operation Manual</a></li><li class="md-nav__item"><a href="../../en/pack_guide/" title="Building Package Manual" class="md-nav__link">Building Package Manual</a></li><li class="md-nav__item"><a href="../../en/database/" title="Database Guide" class="md-nav__link">Database Guide</a></li><li class="md-nav__item"><a href="../../en/protocol_guide/" title="bpm Network Protocol" class="md-nav__link">bpm Network Protocol</a></li></ul></nav></li></ul></nav></div></div></div><div class="md-sidebar md-sidebar--secondary" data-md-component="toc"><div class="md-sidebar__scrollwrap"><div class="md-sidebar__inner"><nav class="md-nav md-nav--secondary"><label class="md-nav__title" for="__toc">Table of contents</label><ul class="md-nav__list" data-md-scrollfix><li class="md-nav__item"><a href="#_1" title="基本过程" class="md-nav__link">基本过程</a></li><li class="md-nav__item"><a href="#_2" title="下载请求" class="md-nav__link">下载请求</a><nav class="md-nav"><ul class="md-nav__list"><li class="md-nav__item"><a href="#_3" title="格式" class="md-nav__link">格式</a></li><li class="md-nav__item"><a href="#_4" title="注释" class="md-nav__link">注释</a></li></ul></nav></li><li class="md-nav__item"><a href="#_5" title="回应资源状态" class="md-nav__link">回应资源状态</a><nav class="md-nav"><ul class="md-nav__list"><li class="md-nav__item"><a href="#_6" title="格式" class="md-nav__link">格式</a></li><li class="md-nav__item"><a href="#_7" title="注释" class="md-nav__link">注释</a></li></ul></nav></li><li class="md-nav__item"><a href="#_8" title="下载分片" class="md-nav__link">下载分片</a><nav class="md-nav"><ul class="md-nav__list"><li class="md-nav__item"><a href="#_9" title="客户端分片请求格式" class="md-nav__link">客户端分片请求格式</a></li><li class="md-nav__item"><a href="#_10" title="服务器发送分片格式" class="md-nav__link">服务器发送分片格式</a></li><li class="md-nav__item"><a href="#_11" title="注释" class="md-nav__link">注释</a></li></ul></nav></li><li class="md-nav__item"><a href="#_12" title="下载结束释放资源" class="md-nav__link">下载结束释放资源</a></li></ul></nav></div></div></div><div class="md-content"><article class="md-content__inner md-typeset"><h1 id="bpm">bpm网络协议手册</h1>
<p>本页面旨在介绍bpm在网络上传输包的相关协议。虽然bpm本体已将这些协议的细节抹除，只留下一个接口，但是，如果您想了解bpm的内部构造或者理解bpm的*辣鸡*代码并帮助我们提高它的效率，此文档会变得很有用。</p>
<p>如果您想开发一个新的bpm，并希望接入现有协议，此文档也可以给您的网络部分的设计进行一些指导。</p>
<p>bpm分为以下几个修改了协议的版本：</p>
<ul>
<li>Project-alice-in-wonderland（Protocol version 1）</li>
<li>Project-sakura（Protocol version 2）</li>
</ul>
<p>本文档描述的是<code>Project-sakura</code>版本的协议，协议版本2。</p>
<h2 id="_1">基本过程</h2>
<p>传输的过程分为：</p>
<ol>
<li>客户端向服务器提出下载请求</li>
<li>服务器根据结果向客户端返回数据，确认资源是否存在以及资源的分片个数</li>
<li>客户端根据响应的结果，如果出现差错，则取消，如果存在，下一步</li>
<li>客户端根据服务器的资源分片个数，依次下载各个分片</li>
<li>客户端下载完所有分片后，通知服务器，此后服务器释放相关资源</li>
</ol>
<h2 id="_2">下载请求</h2>
<h3 id="_3">格式</h3>
<table>
<thead>
<tr>
<th align="center">标识符</th>
<th align="center">类型</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">SIGN</td>
<td align="center">Int32 (4 byte)</td>
</tr>
<tr>
<td align="center">TRANSPORT_VER</td>
<td align="center">Int32 (4 byte)</td>
</tr>
<tr>
<td align="center">Verification code</td>
<td align="center">Int32 (4 byte)</td>
</tr>
<tr>
<td align="center">Resources type</td>
<td align="center">Int32 (4 byte)</td>
</tr>
<tr>
<td align="center">Package name length</td>
<td align="center">Int32 (4 byte)</td>
</tr>
<tr>
<td align="center">Package name</td>
<td align="center">Variable</td>
</tr>
</tbody>
</table>
<h3 id="_4">注释</h3>
<ul>
<li><code>SIGN</code>是标识头，以确认这是一个合法的bpm请求，此数值定义在<code>ShareLib.Transport.SIGN</code>，当前数值为<code>61</code></li>
<li><code>TRANSPORT_VER</code>标识当前传输协议的版本号，当传输协议有不向下兼容的情况的时候，此数值变大，对于传输协议不相符的请求，服务器会拒绝请求。此数值定义在<code>ShareLib.Transport.TRANSPORT_VER</code>，当前数值为<code>1</code></li>
<li><code>Verification code</code>用于验证后续服务器发来的包是否是对此请求的响应，此数值在发出时通过随机数产生</li>
<li><code>Resources type</code>指定此请求时请求何种文件，此枚举定义在<code>ShareLib.PackageType</code>，在进行Int的强制类型转换后发出。查看代码以了解各个枚举对应的数值。</li>
<li><code>Resources type</code>中，<code>PackageDatabase</code>指下载<code>package.db</code>；<code>PackageInfo</code>指下载包的依赖文件，也就是JSON文件；而<code>Package</code>即下载包的本体，ZIP文件。</li>
<li><code>Package name length</code>指示<code>Package name</code>的长度</li>
<li><code>Package name</code>标识要下载的包名，此包名需要带上版本号。文本使用UTF8编码。</li>
<li>当<code>Resources type</code>取<code>PackageDatabase</code>时，**不要**传输<code>Package name length</code>和<code>Package name</code>字段。因为<code>package.db</code>是唯一的，无需指定。</li>
</ul>
<h2 id="_5">回应资源状态</h2>
<h3 id="_6">格式</h3>
<table>
<thead>
<tr>
<th align="center">标识符</th>
<th align="center">类型</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">Version check</td>
<td align="center">Bool (1 byte)</td>
</tr>
<tr>
<td align="center">Verification check</td>
<td align="center">Int32 (4 byte)</td>
</tr>
<tr>
<td align="center">Package check</td>
<td align="center">Bool (1 byte)</td>
</tr>
<tr>
<td align="center">Segment count</td>
<td align="center">Int32 (4 byte)</td>
</tr>
<tr>
<td align="center">Signature</td>
<td align="center">byte[] (256 bit)</td>
</tr>
</tbody>
</table>
<h3 id="_7">注释</h3>
<ul>
<li><code>Version check</code>指示传输协议版本号的检查情况，返回<code>true</code>标识检查通过，否则不通过，不通过之后，连接将会被断开。</li>
<li><code>Verification check</code>，即前文发送给服务器的<code>Verification code</code>，此步请客户端验证匹配。匹配不通过请客户端断开连接</li>
<li><code>Package check</code>检查您希望获取的包是否存在。如果不存在将返回<code>false</code>并断开连接</li>
<li><code>Segment count</code>指示你希望获取的文件有多少个分片，只有上述检查都通过了，这个值才能被获取</li>
<li><code>Signature</code>表示需要用于签名验证的数据，当且仅当传输<code>package.db</code>时此字段才存在</li>
<li>在<code>Project-sakura</code>后，bpm引入了签名验证机制，即服务器会对<code>package.db</code>进行签名，以规避中间人攻击。bpm不会对包数据签名，因为包数据的HASH计算结果被记录在<code>package.db</code>中，只要确信<code>package.db</code>来源，即可保证所有内容都是正确的</li>
<li>当你下载<code>package.db</code>时，在检查完<code>Segment count</code>后，如果没任何问题，此时服务端应当已经将你所请求的资源加入资源管理列表并等待传输，但若此时你在检查<code>Signature</code>时发现签名有问题，希望断开链接结束传输，则应当根据后文的 <strong>下载结束释放资源</strong> 章节的方法来关闭链接而不是直接关闭链接，否则服务器资源无法释放，同时，这个断开操作应当由客户端执行，因为服务端不会了解到你识别失败了。</li>
</ul>
<h2 id="_8">下载分片</h2>
<p>下载分片的基本原理是客户端按分片前后顺序依次向服务器发出下载某个分片的请求，然后服务器将数据传输回来，直到下载完毕。</p>
<p>顺序是客户端先发请求，然后等待接受数据，接收完毕后再发下一个分片请求，以此类推。</p>
<h3 id="_9">客户端分片请求格式</h3>
<table>
<thead>
<tr>
<th align="center">标识符</th>
<th align="center">类型</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">Index</td>
<td align="center">Int32 (4 byte)</td>
</tr>
</tbody>
</table>
<h3 id="_10">服务器发送分片格式</h3>
<table>
<thead>
<tr>
<th align="center">标识符</th>
<th align="center">类型</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">Segment size</td>
<td align="center">Int32 (4 byte)</td>
</tr>
<tr>
<td align="center">Segment data</td>
<td align="center">Variable</td>
</tr>
</tbody>
</table>
<h3 id="_11">注释</h3>
<ul>
<li><code>Index</code>是从<code>1</code>开始计数，而不是传统意义上的从<code>0</code>开始</li>
<li><code>Segment size</code>指示<code>Segment data</code>的长度</li>
<li><code>Segment data</code>是文件本体，在获得后无需过多操作，直接按顺序写入文件即可</li>
</ul>
<h2 id="_12">下载结束释放资源</h2>
<p>理论上，分片下载是可以乱序下载的，并可以加上重传机制。因此服务器不会计数以自动关闭资源，需要由客户端手动命令服务器关闭连接释放资源。</p>
<p>使用 <strong>客户端分片请求格式</strong> 并指定<code>Index</code>为<code>0</code>即可标识客户端下载结束，并使服务器释放资源。</p></article></div></div></main><footer class="md-footer"><div class="md-footer-nav"><nav class="md-footer-nav__inner md-grid"><a href="../database/" title="数据库指南" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev"><div class="md-flex__cell md-flex__cell--shrink"><i class="md-icon md-icon--arrow-back md-footer-nav__button"></i></div><div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title"><span class="md-flex__ellipsis"><span class="md-footer-nav__direction">Previous</span>数据库指南</span></div></a><a href="../../en/MAIN/" title="Home Page" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next"><div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title"><span class="md-flex__ellipsis"><span class="md-footer-nav__direction">Next</span>Home Page</span></div><div class="md-flex__cell md-flex__cell--shrink"><i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i></div></a></nav></div><div class="md-footer-meta md-typeset"><div class="md-footer-meta__inner md-grid"><div class="md-footer-copyright"><div class="md-footer-copyright__highlight">Text is available under the <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC-BY-NC-SA 4.0</a>. Supported by <a href="https://github.com/BearKidsTeam">BearKidsTeam</a>.</div>powered by <a href="https://www.mkdocs.org">MkDocs</a> and <a href="https://squidfunk.github.io/mkdocs-material/">Material for MkDocs</a></div><div class="md-footer-social"><link rel="stylesheet" href="../../assets/fonts/font-awesome.css"> <a href="https://github.com/yyc12345/bpm_wiki" class="md-footer-social__link fa fa-github"></a>  <a href="https://discord.gg/hyarMPm" class="md-footer-social__link fa fa-discord"></a> </div></div></div></footer></div><script src="../../assets/javascripts/application.b260a35d.js"></script><script>app.initialize({version:"1.0.4",url:{base:"../.."}})</script><script src="../../javascript/website.js"></script></body></html>